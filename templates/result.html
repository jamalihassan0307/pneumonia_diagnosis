{% extends 'base.html' %}

{% block title %}Analysis Result - Pneumonia Diagnosis System{% endblock %}

{% block extra_css %}
<style>
    .result-container {
        text-align: center;
    }
    
    .prediction-box {
        padding: 40px;
        border-radius: 15px;
        margin: 20px 0;
        color: white;
    }
    
    .pneumonia-result {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .normal-result {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    }
    
    .prediction-label {
        font-size: 3em;
        font-weight: bold;
        margin: 20px 0;
    }
    
    .confidence-bar {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 5px;
        margin: 20px 0;
        height: 30px;
        overflow: hidden;
    }
    
    .confidence-fill {
        background: rgba(255, 255, 255, 0.8);
        height: 100%;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-weight: bold;
        transition: width 1s ease;
    }
    
    .probabilities {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    
    .prob-item {
        background: white;
        padding: 20px;
        border-radius: 10px;
        color: #333;
    }
    
    .prob-label {
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .prob-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
    }
    
    .result-details {
        text-align: left;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .processing-time {
        color: #666;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="card result-container">
    <h1>‚úÖ Analysis Complete</h1>
</div>

<!-- DEMO MODE WARNING -->
{% if demo_mode %}
<div class="card" style="background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 20px;">
    <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è DEMO MODE ACTIVE</div>
    <p style="color: #d32f2f; font-weight: 600; margin-bottom: 10px;">
        ‚õî This is NOT actual AI prediction. These results are simulated for demonstration only.
    </p>
    <p style="margin-bottom: 10px;">
        <strong>Why?</strong> TensorFlow is not installed. The AI model cannot load.
    </p>
    <p style="margin-bottom: 15px;">
        <strong>To get REAL predictions:</strong>
    </p>
    <ol style="margin-left: 20px;">
        <li><strong>Install Python 3.11</strong> (TensorFlow doesn't support Python 3.14 yet)</li>
        <li><strong>Create virtual environment:</strong> <code>python -m venv venv</code></li>
        <li><strong>Install dependencies:</strong> <code>pip install -r requirements.txt</code></li>
        <li><strong>Restart Django:</strong> <code>python manage.py runserver</code></li>
    </ol>
    <p style="margin-top: 15px; color: #d32f2f;">
        üìñ See <code>TENSORFLOW_SETUP.md</code> for detailed instructions
    </p>
</div>
{% endif %}

<!-- Main Result -->
<div class="card">
    <div class="prediction-box {% if result.prediction_label == 'PNEUMONIA' %}pneumonia-result{% else %}normal-result{% endif %}">
        <div style="font-size: 5em;">
            {% if result.prediction_label == 'PNEUMONIA' %}
                üö®
            {% else %}
                ‚úÖ
            {% endif %}
        </div>
        
        <div class="prediction-label">
            {% if result.prediction_label == 'PNEUMONIA' %}
                PNEUMONIA DETECTED
            {% else %}
                NORMAL - NO PNEUMONIA
            {% endif %}
        </div>
        
        <div style="font-size: 2em; margin: 15px 0;">
            {{ confidence_percentage|floatformat:2 }}% Confidence
        </div>
        
        <div class="confidence-bar">
            <div class="confidence-fill" style="width: {{ confidence_percentage }}%;">
            </div>
        </div>
        
        <div style="font-size: 1.1em;">
            Confidence Level: 
            {% if result.confidence_level == 'HIGH' %}
                <strong style="color: #d4edda;">üü¢ HIGH</strong>
            {% elif result.confidence_level == 'MODERATE' %}
                <strong style="color: #fff3cd;">üü° MODERATE</strong>
            {% else %}
                <strong style="color: #f8d7da;">üî¥ LOW</strong>
            {% endif %}
        </div>
    </div>
</div>

<!-- Detailed Results -->
<div class="card">
    <h2>üìä Detailed Analysis</h2>
    
    <div class="probabilities">
        <div class="prob-item">
            <div class="prob-label">üè• Normal Probability</div>
            <div class="prob-value">{{ raw_predictions.NORMAL|default:"0.00"|floatformat:4 }}</div>
        </div>
        <div class="prob-item">
            <div class="prob-label">‚ö†Ô∏è Pneumonia Probability</div>
            <div class="prob-value">{{ raw_predictions.PNEUMONIA|default:"0.00"|floatformat:4 }}</div>
        </div>
    </div>
</div>

<!-- Result Information -->
<div class="card result-details">
    <h2>‚ÑπÔ∏è Result Information</h2>
    
    <div class="detail-row">
        <span><strong>Image:</strong></span>
        <span>{{ result.image.original_filename }}</span>
    </div>
    
    <div class="detail-row">
        <span><strong>Image Format:</strong></span>
        <span>{{ result.image.format }} ({{ result.image.get_file_size_mb }} MB)</span>
    </div>
    
    <div class="detail-row">
        <span><strong>Image Dimensions:</strong></span>
        <span>{{ result.image.image_width }} x {{ result.image.image_height }} pixels</span>
    </div>
    
    <div class="detail-row">
        <span><strong>Analysis Date:</strong></span>
        <span>{{ result.created_at|date:"F d, Y H:i:s" }}</span>
    </div>
    
    <div class="detail-row">
        <span><strong>Processing Time:</strong></span>
        <span class="processing-time">{{ result.processing_time }} seconds</span>
    </div>
    
    <div class="detail-row">
        <span><strong>Model Version:</strong></span>
        <span>{{ result.model_version.model_name }} {% if result.model_version %}v{{ result.model_version.version }}{% endif %}</span>
    </div>
</div>

<!-- Actions -->
<div class="card" style="text-align: center;">
    <h2>üìã Next Steps</h2>
    
    <a href="{% url 'model_service:upload' %}" class="btn btn-primary">üì§ Analyze Another Image</a>
    <a href="{% url 'model_service:history' %}" class="btn btn-secondary">üìú View History</a>
    <a href="{% url 'model_service:dashboard' %}" class="btn btn-secondary">üìä Back to Dashboard</a>
    
    <form method="post" action="{% url 'model_service:delete' result.id %}" style="display: inline; margin-top: 15px;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this result?');">üóëÔ∏è Delete Result</button>
    </form>
</div>

<!-- Medical Disclaimer -->
<div class="card" style="border-left: 4px solid #dc3545; background: #fff5f5;">
    <h2>‚ö†Ô∏è Important Medical Disclaimer</h2>
    
    <div style="color: #721c24;">
        <p>
            <strong>This is a preliminary screening result only.</strong> 
            This AI-assisted analysis is designed to support clinical decision-making but 
            <strong>IS NOT A MEDICAL DIAGNOSIS</strong>.
        </p>
        
        <p><strong>Critical Points:</strong></p>
        <ul style="margin-left: 20px;">
            <li>Results must be reviewed and confirmed by a qualified radiologist</li>
            <li>Do not make clinical decisions based solely on this result</li>
            <li>Consider clinical presentation and patient history in your assessment</li>
            <li>This system may produce false positives or false negatives</li>
            <li>Follow your institution's established diagnostic protocols</li>
            <li>Report any discrepancies to your supervisor or quality assurance team</li>
        </ul>
        
        <p>
            <strong>Responsibility:</strong> As a medical professional, you are solely responsible 
            for all diagnostic and clinical decisions. This tool is provided as an aid to be used 
            in conjunction with your professional expertise and institutional guidelines.
        </p>
    </div>
</div>
{% endblock %}
